(()=>{"use strict";let e=null,t=null,n=!1,o=null;function l(){if(!t)return;const e=document.getElementById("downloadBtn");if(!e)return;i(e,!0,"下载选中字幕");const n=document.querySelectorAll('input[type="checkbox"]:checked'),o=Array.from(n).filter((e=>"selectAll"!==e.id)).map((e=>{const n=parseInt(e.id.replace("video-",""));return t[n]}));console.log("Selected videos:",o);const l=o.map((({id:e,title:t})=>new Promise((n=>{chrome.runtime.sendMessage({action:"downloadTranscripts",videoIds:[e]},(o=>{if(o&&o[e]){const n=o[e];"string"==typeof n&&(n.startsWith("Error:")||"No captions available for this video."===n?console.error(`Error for video "${t}": ${n}`):s(n,`${t}.txt`))}else console.error(`无法下载视频 "${t}" 的字幕`);n()}))}))));Promise.all(l).then((()=>{i(e,!1,"下载选中字幕")})).catch((t=>{console.error("Error downloading transcripts:",t),alert("下载字幕时出错，请稍后重试。"),i(e,!1,"下载选中字幕")}))}function r(){if(n)return void console.log("Word list generation already in progress");console.log("generateWordList function called"),n=!0;let l=[];if(e)l=[e];else if(t){const e=document.querySelectorAll('input[type="checkbox"]:checked');l=Array.from(e).filter((e=>"selectAll"!==e.id)).map((e=>{const n=parseInt(e.id.replace("video-",""));return t[n]}))}if(console.log("Selected videos for word list:",l),0===l.length)return alert("请至少选择一个视频"),void(n=!1);const r=document.getElementById("generateWordListBtn");i(r,!0,"生成单词列表");const c=l.map((({id:e,title:t})=>new Promise((n=>{chrome.runtime.sendMessage({action:"downloadTranscripts",videoIds:[e]},(o=>{if(o&&o[e]){const l=o[e];"string"!=typeof l||l.startsWith("Error:")||"No captions available for this video."===l?(console.error(`Error for video "${t}": ${l}`),n("")):n(l)}else console.error(`无法下载视频 "${t}" 的字幕`),n("")}))}))));Promise.all(c).then((e=>{const t=e.filter((e=>""!==e));t.length>0?chrome.runtime.sendMessage({action:"generateWordList",transcripts:t},(e=>{const t=e.join("\n");let n;n=1===l.length?`${l[0].title}_unique_words.txt`:o?`${o}_unique_words.txt`:"multiple_videos_unique_words.txt",n=n.replace(/[<>:"/\\|?*]/g,"_"),s(t,n),i(r,!1,"生成单词列表")})):(alert("无法生成单词列表，请确保至少有一个视频的字幕可以下载。"),i(r,!1,"生成单词列表"))})).catch((e=>{console.error("Error generating word list:",e),alert("生成单词列表时出错，请稍后重试。"),i(r,!1,"生成单词列表")})).finally((()=>{n=!1}))}function i(e,t,n){if(t){e.disabled=!0;const t='<div class="loader ml-2 inline-block"></div>';e.innerHTML=`${n} ${t}`}else e.disabled=!1,e.textContent=n}function s(e,t){const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),l=document.createElement("a");l.href=o,l.download=t,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o)}document.addEventListener("DOMContentLoaded",(()=>{console.log("DOMContentLoaded event fired");const n=document.getElementById("generateWordListBtn");n&&(n.removeEventListener("click",r),n.addEventListener("click",r)),chrome.tabs.query({active:!0,currentWindow:!0},(n=>{chrome.tabs.sendMessage(n[0].id,{action:"getInfo"},(n=>{if(n)!function(n){const r=document.getElementById("info"),c=document.getElementById("playlist"),d=document.getElementById("downloadBtn"),a=document.getElementById("generateWordListBtn");r&&c&&d&&a&&(n.videoInfo?(e=n.videoInfo,t=null,o=null,r.innerHTML=`\n        <h2 class="text-xl font-semibold mb-3">当前视频</h2>\n        <p class="text-sm mb-2"><span class="font-medium">标题:</span> ${n.videoInfo.title}</p>\n        <p class="text-sm"><span class="font-medium">ID:</span> ${n.videoInfo.id}</p>\n      `,d.textContent="下载字幕",d.onclick=()=>function(e){const t=document.getElementById("downloadBtn");t&&(i(t,!0,"下载字幕"),chrome.runtime.sendMessage({action:"downloadTranscripts",videoIds:[e.id]},(n=>{if(i(t,!1,"下载字幕"),n&&n[e.id]){const t=n[e.id];"string"==typeof t&&(t.startsWith("Error:")||"No captions available for this video."===t?alert(`Error: ${t}`):s(t,`${e.title}.txt`))}else alert("无法下载字幕，请稍后重试。")})))}(n.videoInfo),c.style.display="none"):n.playlistInfo&&n.playlistInfo.length>0?(e=null,t=n.playlistInfo,o=n.playlistTitle||"Playlist",function(e){const t=document.getElementById("playlist-items"),n=document.getElementById("selectAll");t&&n&&(t.innerHTML="",e.forEach(((e,n)=>{const o=document.createElement("li");o.className="flex items-center justify-between bg-gray-50 p-3 rounded-lg";const l=document.createElement("div");l.className="flex items-center flex-1 min-w-0";const r=function(e,t=!0){const n=document.createElement("input");return n.type="checkbox",n.id=e,n.checked=t,n.className="mr-2",n}(`video-${n}`,!0);r.className="form-checkbox h-5 w-5 text-blue-600 transition duration-150 ease-in-out";const i=function(e,t){const n=document.createElement("label");return n.htmlFor=e,n.textContent=t,n.className="text-sm",n}(`video-${n}`,e.title);i.className="ml-2 text-sm text-gray-700 truncate",l.appendChild(r),l.appendChild(i),o.appendChild(l),t.appendChild(o)})),n.checked=!0,n.addEventListener("change",(function(){document.querySelectorAll('input[type="checkbox"]').forEach((e=>{"selectAll"!==e.id&&(e.checked=n.checked)}))})),n.dispatchEvent(new Event("change")))}(n.playlistInfo),d.textContent="下载选中字幕",d.onclick=l,c.style.display="block"):(e=null,t=null,o=null,r.innerHTML='\n        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded" role="alert">\n          <p class="font-bold">提示</p>\n          <p>未找到视频或播放列表信息。请确保您在YouTube视频或播放列表页面上。</p>\n        </div>\n      ',c.style.display="none"),i(d,!1,d.textContent||"下载字幕"),i(a,!1,"生成单词列表"))}(n);else{const e=document.getElementById("info");e&&(e.innerHTML='\n            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded" role="alert">\n              <p class="font-bold">提示</p>\n              <p>未找到视频或播放列表信息。请确保您在YouTube视频或播放列表页面上。</p>\n            </div>\n          ')}}))}))}))})();